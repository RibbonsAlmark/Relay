<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Confirm Range Rating</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 40px; color: #2c3e50; line-height: 1.6; }
        .card { display: inline-block; background: #f8f9fa; padding: 25px; border-radius: 12px; border: 1px solid #e1e4e8; text-align: left; min-width: 400px; }
        .ts-box { background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #ddd; font-family: monospace; margin: 10px 0; }
        .btn-group { margin-top: 30px; display: flex; justify-content: space-around; }
        button { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1.1em; transition: transform 0.1s; }
        button:active { transform: scale(0.95); }
        .btn-a { background: #2ecc71; color: white; }
        .btn-b { background: #3498db; color: white; }
        .btn-c { background: #f1c40f; color: white; }
        .btn-d { background: #e67e22; color: white; }
        .loading { display: none; color: #7f8c8d; margin-top: 20px; }
    </style>
</head>
<body>
    <h2>âš¡ åŒºé—´æ‰“åˆ†ç¡®è®¤</h2>
    
    <div class="card">
        <p><strong>æ•°æ®åº“:</strong> {{ db }}</p>
        <p><strong>æ•°æ®é›†:</strong> {{ col }}</p>
        <hr>
        <p>ğŸš© <b>å¼€å§‹æ—¶é—´æˆ³:</b></p>
        <div id="start_ts" class="ts-box">Loading...</div>
        <p>ğŸ <b>ç»“æŸæ—¶é—´æˆ³:</b></p>
        <div id="end_ts" class="ts-box">Loading...</div>
    </div>

    <div id="action-area">
        <p style="margin-top: 20px; color: #7f8c8d;">è¯·é€‰æ‹©è¯„çº§ä»¥æäº¤ï¼š</p>
        <div class="btn-group">
            <button class="btn-a" onclick="submitRange('A')">A</button>
            <button class="btn-b" onclick="submitRange('B')">B</button>
            <button class="btn-c" onclick="submitRange('C')">C</button>
            <button class="btn-d" onclick="submitRange('D')">D</button>
        </div>
    </div>

    <div id="loading" class="loading">ğŸš€ æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</div>

    <script>
        // 1. ä» localStorage è·å–æ—¶é—´æˆ³
        const startTs = localStorage.getItem('dp_tagger_range_start');
        const endTs = localStorage.getItem('dp_tagger_range_end');

        // 2. æ£€æŸ¥å¹¶æ˜¾ç¤º
        if (!startTs || !endTs) {
            document.body.innerHTML = "<h2 style='color:#e74c3c;'>âŒ é”™è¯¯ï¼šæœªæ£€æµ‹åˆ°å®Œæ•´çš„åŒºé—´è®¾å®š</h2><p>è¯·å…ˆåœ¨ Rerun ä¸­è®¾ç½®èµ·ç‚¹å’Œç»ˆç‚¹ã€‚</p>";
        } else {
            document.getElementById('start_ts').innerText = startTs;
            document.getElementById('end_ts').innerText = endTs;
        }

        // 3. å¼‚æ­¥æäº¤å‡½æ•°
        async function submitRange(score) {
            const payload = {
                src_database: "{{ db }}",
                src_collection: "{{ col }}",
                dst_database: "{{ db }}",
                dst_collection: "{{ col }}",
                score: score,
                start_timestamp: startTs,
                end_timestamp: endTs,
                comment: "Range rated via Web UI"
            };

            // UI åˆ‡æ¢åˆ°åŠ è½½çŠ¶æ€
            document.getElementById('action-area').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            try {
                // --- 1. æäº¤è¯„åˆ†è¯·æ±‚ ---
                const rateResponse = await fetch('/rate_range', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (rateResponse.ok) {
                    const result = await rateResponse.json();
                    
                    // --- 2. æ ¸å¿ƒæ“ä½œï¼šè°ƒç”¨å·²æœ‰çš„ refresh_ui æ¥å£ ---
                    const uuid = "{{ recording_uuid }}";
                    if (uuid && uuid !== "None" && uuid !== "") {
                        console.log("Requesting UI refresh for:", uuid);
                        
                        // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨çš„æ˜¯ä½ å®šä¹‰çš„ POST /refresh_ui/{uuid}
                        try {
                            await fetch(`/refresh_ui/${uuid}`, {
                                method: 'POST'
                            });
                        } catch (refreshErr) {
                            console.error("UI Refresh failed but rating was successful:", refreshErr);
                        }
                    }

                    alert('âœ… æˆåŠŸå¤„ç† ' + result.processed_count + ' å¸§ï¼');
                    
                    // æ¸…ç†å¹¶å…³é—­
                    localStorage.removeItem('dp_tagger_range_start');
                    localStorage.removeItem('dp_tagger_range_end');
                    window.close();
                } else {
                    const error = await rateResponse.json();
                    alert('âŒ æäº¤å¤±è´¥: ' + (error.detail || 'æœªçŸ¥é”™è¯¯'));
                    document.getElementById('action-area').style.display = 'block';
                    document.getElementById('loading').style.display = 'none';
                }
            } catch (error) {
                alert('âŒ ç½‘ç»œè¯·æ±‚å¼‚å¸¸');
                console.error(error);
                document.getElementById('action-area').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
        }
    </script>
</body>
</html>